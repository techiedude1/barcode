<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>All Barcode & Label Tools</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <style>
    body { font-family: 'Inter', Arial, sans-serif; background: #f0f9ff; min-height: 100vh; margin: 0; padding: 0; }
    .main-title { font-size: 2.1rem; font-weight: 800; color: #374151; margin-top: 2.2rem; text-align: center; letter-spacing: .02em;}
    .tools-container { display: flex; flex-wrap: wrap; gap: 38px; justify-content: center; align-items: flex-start; margin: 2.3rem 0 2.7rem 0;}
    .barcode-tool { background: #fff; padding: 32px 22px 28px 22px; border-radius: 20px; box-shadow: 0 6px 28px rgba(0,0,0,0.07); width: 375px; max-width: 98vw; margin-bottom: 1.2rem; }
    .tool-title { font-size: 1.22rem; font-weight: 700; color: #2563eb; margin-bottom: 13px; text-align: center; }
    .input { font-size: 1rem; padding: 10px; border-radius: 10px; border: 1px solid #cbd5e1; width: 100%; margin-bottom: 12px; }
    .barcode-preview { display: flex; flex-direction: column; align-items: center; margin: 16px 0 0 0;}
    .barcode-number { margin-top: 4px; font-size: 1.1rem; font-weight: 600; color: #f59e42; letter-spacing: 2px;}
    .display-text { margin-top: 6px; font-weight: 600; font-size: 1.05rem; color: #334155; }
    .exp-lot-row { margin-top: 8px; width: 100%; display: flex; justify-content: center; gap: 30px;}
    .btn { background: #2563eb; color: #fff; padding: 10px 20px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: background .2s; }
    .btn:disabled { background: #cbd5e1; cursor: not-allowed; }
    .notice { color: #64748b; font-size: 0.89rem; margin-top: 8px; text-align: center; }
    .fallback-img-container { margin-top: 1.1rem; padding: 1rem; border: 1px dashed #cbd5e1; border-radius: 0.5rem; background-color: #f9fafb; text-align: center;}
    .fallback-img { display: block; margin: 0.5rem auto; border: 1px solid #e5e7eb; max-width: 100%; border-radius: 0.25rem; }
    .row-exp-lot { display: flex; gap: 10px; justify-content: center; margin-top: 8px; }
    .exp-lot-label { font-weight: 600; }
    .exp-lot-input { font-size: 1rem; padding: 6px 7px; border: 1.5px solid #cbd5e1; border-radius: 8px; width: 90px; margin-left: 2px; }
    .exp-lot-input:focus { border-color: #2563eb; outline: none; }

    /* Tool 4 Only */
    .tool4-title { font-size: 1.13rem; font-weight: 700; color: #2563eb; margin-bottom: 13px; text-align: center; }
    .t4-container { background: #fff; padding: 30px 18px 20px 18px; border-radius: 20px; box-shadow: 0 6px 28px rgba(0,0,0,0.07); max-width: 410px; margin: 0 auto; }
    .t4-inputrow { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px; }
    .t4-lbl { font-weight: 600; }
    .t4-fill {
      border: none; border-bottom: 2px solid #aaa; background: none; font-size: 1rem; font-weight: bold;
      min-width: 40px; text-align: center; outline: none; margin: 0 3px; transition: width 0.2s; height: 2.2em; line-height: 2.2em;
      padding: 2px 6px 2px 6px; box-sizing: border-box;
    }
    .t4-fill:focus { border-color: #2563eb; }
    .t4-copy-btn { background: #2563eb; color: #fff; padding: 10px 20px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; margin-top: 12px; }
    .t4-copy-btn:disabled { background: #cbd5e1; cursor: not-allowed; }
    .t4-notice { color: #64748b; font-size: 0.87rem; margin-top: 8px; text-align: center; }
    #t4-barcodePreview { display: block; margin: 0 auto 10px auto; background: #fff; }
  </style>
<link rel="icon" type="image/png" href="images/barcode-favicon.png">
</head>
<body>
  <div class="main-title">Barcode & Label Tools</div>
  <div class="tools-container">

    <!-- TOOL 1 -->
    <div class="barcode-tool">
      <div class="tool-title">Barcode & Text Copier (with Fallback)</div>
      <input type="text" id="t1-barcode" class="input" placeholder="Barcode data (any value)">
      <textarea id="t1-addtext" class="input" rows="2" placeholder="Additional Text"></textarea>
      <div id="t1-preview" class="barcode-preview" style="min-height:120px;">
        <svg id="t1-barcode-svg" width="260" height="60"></svg>
        <div id="t1-displaytext" class="display-text"></div>
      </div>
      <button class="btn" id="t1-copybtn" disabled>Copy as Image</button>
      <div class="notice" id="t1-status"></div>
      <div id="t1-fallback" class="fallback-img-container" style="display:none;">
        <div style="font-size:0.93rem; color:#64748b;">Right-click below image to copy:</div>
        <img id="t1-fallback-img" class="fallback-img" alt="Barcode+Text"/>
      </div>
    </div>

    <!-- TOOL 2 -->
    <div class="barcode-tool">
      <div class="tool-title">Barcode + Text Generator</div>
      <input id="t2-barcode" class="input" type="text" placeholder="Enter value for barcode..." autocomplete="off">
      <input id="t2-text" class="input" type="text" placeholder="Enter display text..." autocomplete="off">
      <div id="t2-preview" class="barcode-preview" style="display:none;">
        <svg id="t2-barcode-svg" width="260" height="60"></svg>
        <div id="t2-barnum" class="barcode-number"></div>
        <div id="t2-displaytext" class="display-text"></div>
      </div>
      <button class="btn" id="t2-copybtn" disabled>Copy Barcode & Text as Image</button>
      <div class="notice">Paste directly where image pasting is supported (Docs, email, chat, etc.)</div>
    </div>

    <!-- TOOL 3 -->
    <div class="barcode-tool">
      <div class="tool-title">Barcode + Text + EXP/LOT</div>
      <input id="t3-barcode" class="input" type="text" placeholder="Barcode value..." autocomplete="off">
      <input id="t3-text" class="input" type="text" placeholder="Display text..." autocomplete="off">
      <div class="row-exp-lot">
        <label class="exp-lot-label" for="t3-exp">EXP:</label>
        <input id="t3-exp" class="exp-lot-input" type="text" maxlength="16" placeholder="MM/YYYY">
        <label class="exp-lot-label" for="t3-lot">LOT#</label>
        <input id="t3-lot" class="exp-lot-input" type="text" maxlength="16" placeholder="">
      </div>
      <div id="t3-preview" class="barcode-preview" style="display:none;">
        <svg id="t3-barcode-svg" width="320" height="60"></svg>
        <div id="t3-barnum" class="barcode-number"></div>
        <div id="t3-displaytext" class="display-text"></div>
        <div style="display:flex;justify-content:center;gap:36px;margin-top:7px;">
          <span><b>EXP:</b> <span id="t3-expout" style="display:inline-block;min-width:80px;border-bottom:1.5px solid #aaa;">&nbsp;</span></span>
          <span><b>LOT#:</b> <span id="t3-lotout" style="display:inline-block;min-width:90px;border-bottom:1.5px solid #aaa;">&nbsp;</span></span>
        </div>
      </div>
      <button class="btn" id="t3-copybtn" disabled>Copy Barcode & Text as Image</button>
      <div class="notice">EXP and LOT fields included in copied image.</div>
    </div>
  </div>

  <!-- TOOL 4 (centered, label generator, all fields, dynamic width, barcode) -->
  <div class="t4-container" style="margin-bottom:42px;">
    <div class="tool4-title">Centered Custom Label Generator (All Fields, Barcode, Dynamic Layout)</div>
    <div class="t4-inputrow">
      <input id="t4-line1" class="t4-fill" type="text" style="width:360px;" maxlength="48" placeholder=" " autocomplete="off">
    </div>
    <div class="t4-inputrow">
      <input id="t4-mgVal" class="t4-fill" type="text" maxlength="10" style="width:75px;">
      <span class="t4-lbl" style="margin-left:6px;margin-right:6px;">mg PER</span>
      <input id="t4-mlVal" class="t4-fill" type="text" maxlength="10" style="width:75px;">
      <span class="t4-lbl" style="margin-left:6px;">mL</span>
    </div>
    <div class="t4-inputrow">
      <span class="t4-lbl">LOT#</span>
      <input id="t4-lotVal" class="t4-fill" type="text" maxlength="32" style="width:80px;" autocomplete="off">
      <span class="t4-lbl" style="margin-left:12px;">MAN:</span>
      <input id="t4-manVal" class="t4-fill" type="text" maxlength="32" style="width:90px;" autocomplete="off">
    </div>
    <div class="t4-inputrow">
      <span class="t4-lbl">EXP:</span>
      <input id="t4-expMonth" class="t4-fill" type="text" maxlength="2" style="width:34px;">
      <span class="t4-lbl">/</span>
      <input id="t4-expDay" class="t4-fill" type="text" maxlength="2" style="width:34px;">
      <span class="t4-lbl">/</span>
      <input id="t4-expYear" class="t4-fill" type="text" maxlength="4" style="width:48px;">
    </div>
    <div class="t4-inputrow">
      <span class="t4-lbl">Barcode:</span>
      <input id="t4-barcodeVal" class="t4-fill" type="text" maxlength="24" style="width:210px;" placeholder="Enter barcode (numbers or letters)">
    </div>
    <svg id="t4-barcodePreview" width="320" height="60"></svg>
    <button class="t4-copy-btn" id="t4-copyBtn">Copy Label as Image</button>
    <div class="t4-notice">All fields are fillable. Paste the copied label image anywhere that supports image pasting (Word, Docs, email, etc.).</div>
  </div>

  <script>
    // ========== TOOL 1 ==========
    const t1barcodeInput = document.getElementById('t1-barcode');
    const t1addTextInput = document.getElementById('t1-addtext');
    const t1barcodeSVG = document.getElementById('t1-barcode-svg');
    const t1displayText = document.getElementById('t1-displaytext');
    const t1copyBtn = document.getElementById('t1-copybtn');
    const t1status = document.getElementById('t1-status');
    const t1fallback = document.getElementById('t1-fallback');
    const t1fallbackImg = document.getElementById('t1-fallback-img');
    function t1update() {
      try {
        JsBarcode(t1barcodeSVG, t1barcodeInput.value, { format: "CODE128", displayValue: true, width: 2, height: 60, margin: 8, fontSize: 16 });
      } catch {}
      t1displayText.textContent = t1addTextInput.value;
      t1copyBtn.disabled = !t1barcodeInput.value && !t1addTextInput.value;
      t1fallback.style.display = 'none'; t1status.textContent = '';
    }
    t1barcodeInput.addEventListener('input', t1update);
    t1addTextInput.addEventListener('input', t1update);

    t1copyBtn.addEventListener('click', async () => {
      t1status.textContent = ''; t1fallback.style.display = 'none';
      const hasBarcode = !!t1barcodeInput.value;
      const hasText = !!t1addTextInput.value;
      if (!hasBarcode && !hasText) return;
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const svgXml = new XMLSerializer().serializeToString(t1barcodeSVG);
      const svgDataUrl = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svgXml)}`;
      const img = new Image();
      await new Promise((res, rej) => {
        img.onload = res;
        img.onerror = rej;
        img.src = svgDataUrl;
      });
      let textLines = [];
      let textFont = 'bold 16px Inter, Arial, sans-serif';
      ctx.font = textFont;
      if (hasText) {
        const words = t1addTextInput.value.split(/(\s+)/);
        let line = '';
        for (const w of words) {
          let test = line + w;
          if (ctx.measureText(test.trim()).width > 260 && line.trim() !== '') {
            textLines.push(line.trim()); line = w;
          } else line = test;
        }
        if (line.trim() !== '') textLines.push(line.trim());
      }
      const padding = 16, barcodeHeight = 60;
      const textHeight = textLines.length * 22;
      canvas.width = 300;
      canvas.height = barcodeHeight + textHeight + padding * 2;
      ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 20, padding, 260, 60);
      ctx.font = textFont; ctx.fillStyle = "#374151"; ctx.textAlign = 'center';
      textLines.forEach((line, i) => {
        ctx.fillText(line, canvas.width/2, barcodeHeight + padding + 18 + i * 22);
      });
      canvas.toBlob(async (blob) => {
        try {
          await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
          t1status.textContent = 'Copied as image!';
          t1status.style.color = "#16a34a";
        } catch {
          t1status.textContent = 'Copy failed. Right-click image below to copy.';
          t1status.style.color = "#b91c1c";
          t1fallbackImg.src = canvas.toDataURL();
          t1fallback.style.display = 'block';
        }
      });
    });
    t1update();

    // ========== TOOL 2 ==========
    const t2barcodeInput = document.getElementById('t2-barcode');
    const t2textInput = document.getElementById('t2-text');
    const t2barcodeSVG = document.getElementById('t2-barcode-svg');
    const t2barnum = document.getElementById('t2-barnum');
    const t2displayText = document.getElementById('t2-displaytext');
    const t2preview = document.getElementById('t2-preview');
    const t2copyBtn = document.getElementById('t2-copybtn');
    function t2formatNumber(val) { return val.replace(/\D/g, ''); }
    function t2update() {
      const val = t2barcodeInput.value;
      if (val) {
        try {
          JsBarcode(t2barcodeSVG, val, { format: "CODE128", displayValue: false, width: 2, height: 60, margin: 0 });
          t2barnum.textContent = t2formatNumber(val);
          t2displayText.textContent = t2textInput.value;
          t2preview.style.display = 'flex';
          t2copyBtn.disabled = false;
        } catch { t2preview.style.display = 'none'; t2copyBtn.disabled = true; }
      } else { t2preview.style.display = 'none'; t2copyBtn.disabled = true; }
    }
    t2barcodeInput.addEventListener('input', t2update);
    t2textInput.addEventListener('input', t2update);

    t2copyBtn.addEventListener('click', async () => {
      const svgString = new XMLSerializer().serializeToString(t2barcodeSVG);
      const img = new Image();
      const svgBlob = new Blob([svgString], {type:'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(svgBlob);
      img.src = url;
      img.onload = async function() {
        const w = 260, h = 60, numberLine = 22, textLine = 21;
        const canvas = document.createElement('canvas');
        canvas.width = w;
        canvas.height = h + numberLine + textLine;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, w, h);
        ctx.font = "bold 18px Inter, Arial, sans-serif";
        ctx.textAlign = "center"; ctx.fillStyle = "#f59e42";
        ctx.fillText(t2barnum.textContent, w/2, h + numberLine - 5);
        ctx.font = "bold 17px Inter, Arial, sans-serif"; ctx.fillStyle = "#334155";
        ctx.fillText(t2displayText.textContent, w/2, h + numberLine + textLine - 8);
        canvas.toBlob(async (blob) => {
          try {
            await navigator.clipboard.write([new window.ClipboardItem({ [blob.type]: blob })]);
            t2copyBtn.textContent = "Copied!";
            setTimeout(()=>{t2copyBtn.textContent = "Copy Barcode & Text as Image"}, 1200);
          } catch(e) { alert("Copy failed. Try right-clicking the image to copy."); }
          URL.revokeObjectURL(url);
        });
      };
    });

    // ========== TOOL 3 ==========
    const t3barcodeInput = document.getElementById('t3-barcode');
    const t3textInput = document.getElementById('t3-text');
    const t3expInput = document.getElementById('t3-exp');
    const t3lotInput = document.getElementById('t3-lot');
    const t3barcodeSVG = document.getElementById('t3-barcode-svg');
    const t3barnum = document.getElementById('t3-barnum');
    const t3displayText = document.getElementById('t3-displaytext');
    const t3expout = document.getElementById('t3-expout');
    const t3lotout = document.getElementById('t3-lotout');
    const t3preview = document.getElementById('t3-preview');
    const t3copyBtn = document.getElementById('t3-copybtn');
    function t3formatNumber(val) { return val.replace(/\D/g, ''); }
    function t3update() {
      const val = t3barcodeInput.value;
      if (val) {
        try {
          JsBarcode(t3barcodeSVG, val, { format: "CODE128", displayValue: false, width: 2, height: 60, margin: 0 });
          t3barnum.textContent = t3formatNumber(val);
          t3displayText.textContent = t3textInput.value;
          t3expout.textContent = t3expInput.value || '\u00A0';
          t3lotout.textContent = t3lotInput.value || '\u00A0';
          t3preview.style.display = 'flex';
          t3copyBtn.disabled = false;
        } catch { t3preview.style.display = 'none'; t3copyBtn.disabled = true; }
      } else { t3preview.style.display = 'none'; t3copyBtn.disabled = true; }
    }
    t3barcodeInput.addEventListener('input', t3update);
    t3textInput.addEventListener('input', t3update);
    t3expInput.addEventListener('input', t3update);
    t3lotInput.addEventListener('input', t3update);

    t3copyBtn.addEventListener('click', async () => {
      const svgString = new XMLSerializer().serializeToString(t3barcodeSVG);
      const img = new Image();
      const svgBlob = new Blob([svgString], {type:'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(svgBlob);
      img.src = url;
      img.onload = async function() {
        const w = 320, h = 60, numberLine = 22, textLine = 21, expLotLine = 26;
        const canvas = document.createElement('canvas');
        canvas.width = w;
        canvas.height = h + numberLine + textLine + expLotLine + 12;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, w, h);

        ctx.font = "bold 18px Inter, Arial, sans-serif";
        ctx.textAlign = "center";
        ctx.fillStyle = "#f59e42";
        ctx.fillText(t3barnum.textContent, w/2, h + numberLine - 5);

        ctx.font = "bold 17px Inter, Arial, sans-serif";
        ctx.fillStyle = "#334155";
        ctx.fillText(t3displayText.textContent, w/2, h + numberLine + textLine - 8);

        ctx.font = "bold 16px Inter, Arial, sans-serif";
        ctx.fillStyle = "#222";
        ctx.textAlign = "left";
        // EXP:
        ctx.fillText("EXP:", 30, h + numberLine + textLine + expLotLine - 10);
        ctx.font = "16px Inter, Arial, sans-serif";
        ctx.fillText(t3expInput.value, 75, h + numberLine + textLine + expLotLine - 10);
        // Line
        ctx.beginPath(); ctx.moveTo(72, h + numberLine + textLine + expLotLine - 8);
        ctx.lineTo(148, h + numberLine + textLine + expLotLine - 8); ctx.strokeStyle = "#aaa"; ctx.lineWidth = 2; ctx.stroke();

        ctx.font = "bold 16px Inter, Arial, sans-serif";
        ctx.fillText("LOT#:", w/2 + 20, h + numberLine + textLine + expLotLine - 10);
        ctx.font = "16px Inter, Arial, sans-serif";
        ctx.fillText(t3lotInput.value, w/2 + 80, h + numberLine + textLine + expLotLine - 10);
        ctx.beginPath(); ctx.moveTo(w/2 + 77, h + numberLine + textLine + expLotLine - 8);
        ctx.lineTo(w/2 + 164, h + numberLine + textLine + expLotLine - 8); ctx.strokeStyle = "#aaa"; ctx.lineWidth = 2; ctx.stroke();

        canvas.toBlob(async (blob) => {
          try {
            await navigator.clipboard.write([new window.ClipboardItem({ [blob.type]: blob })]);
            t3copyBtn.textContent = "Copied!";
            setTimeout(()=>{t3copyBtn.textContent = "Copy Barcode & Text as Image"}, 1200);
          } catch(e) { alert("Copy failed. Try right-clicking the image to copy."); }
          URL.revokeObjectURL(url);
        });
      };
    });

    // ========== TOOL 4: Custom Label Generator (All Fields, Dynamic Width) ==========
    // Helper to estimate width in px for bold Inter font for input value
    function t4_getTextWidth(text, font) {
      const canvas = t4_getTextWidth.canvas || (t4_getTextWidth.canvas = document.createElement("canvas"));
      const context = canvas.getContext("2d");
      context.font = font;
      return context.measureText(text).width;
    }
    // Dynamic width for LOT# and MAN fields
    function t4_updateFieldWidths() {
      const lotInput = document.getElementById('t4-lotVal');
      const manInput = document.getElementById('t4-manVal');
      const maxWidth = 360, minLotWidth = 80, minManWidth = 90;
      const lotValue = lotInput.value || '';
      const manValue = manInput.value || '';
      lotInput.style.width = Math.max(minLotWidth, Math.min(t4_getTextWidth(lotValue, "bold 1rem Inter") + 20, maxWidth)) + "px";
      manInput.style.width = Math.max(minManWidth, Math.min(t4_getTextWidth(manValue, "bold 1rem Inter") + 20, maxWidth)) + "px";
    }
    document.getElementById("t4-lotVal").addEventListener("input", t4_updateFieldWidths);
    document.getElementById("t4-manVal").addEventListener("input", t4_updateFieldWidths);

    // Utility for drawing a centered line input (field) on canvas
    function t4_drawCenteredLineInput(ctx, cx, y, width, value, labelLeft, labelRight, labelFont, valueFont, underline=true, bold=true) {
      let x = cx - width / 2;
      ctx.font = labelFont;
      ctx.textAlign = "right";
      if (labelLeft) { ctx.fillText(labelLeft, x - 2, y + 0); }
      ctx.textAlign = "left";
      if (labelRight) { ctx.fillText(labelRight, x + width + 2, y + 0); }
      ctx.font = (bold ? "bold " : "") + valueFont;
      ctx.textAlign = "center";
      ctx.fillStyle = "#222";
      if (value) ctx.fillText(value, cx, y - 3);
      if (underline) {
        ctx.strokeStyle = "#aaa";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(x, y+4);
        ctx.lineTo(x + width, y+4);
        ctx.stroke();
      }
    }

    // Render barcode preview when barcodeVal changes
    function t4_renderBarcodePreview() {
      const val = document.getElementById("t4-barcodeVal").value.trim();
      const svg = document.getElementById("t4-barcodePreview");
      if(val) {
        JsBarcode(svg, val, {
          format: "CODE128", lineColor: "#222", width: 2, height: 50, margin: 0,
          displayValue: true, fontOptions: "bold", fontSize: 18, textMargin: 2,
        });
      } else { svg.innerHTML = ''; }
    }
    document.getElementById("t4-barcodeVal").addEventListener("input", t4_renderBarcodePreview);

    document.getElementById("t4-copyBtn").onclick = function() {
      const w = 420, h = 222;
      const canvas = document.createElement("canvas");
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "#fff";
      ctx.fillRect(0, 0, w, h);

      // Get all values
      const line1 = document.getElementById("t4-line1").value;
      const mgVal = document.getElementById("t4-mgVal").value;
      const mlVal = document.getElementById("t4-mlVal").value;
      const lotVal = document.getElementById("t4-lotVal").value;
      const manVal = document.getElementById("t4-manVal").value;
      const expMonth = document.getElementById("t4-expMonth").value;
      const expDay = document.getElementById("t4-expDay").value;
      const expYear = document.getElementById("t4-expYear").value;
      const barcodeVal = document.getElementById("t4-barcodeVal").value.trim();

      // Calculate dynamic widths for canvas
      const lotFont = "bold 16px Inter";
      const manFont = "bold 16px Inter";
      const minLotWidth = 80, minManWidth = 90, maxWidth = 360;
      const lotWidth = Math.max(minLotWidth, Math.min(t4_getTextWidth(lotVal, lotFont) + 20, maxWidth));
      const manWidth = Math.max(minManWidth, Math.min(t4_getTextWidth(manVal, manFont) + 20, maxWidth));

      const cx = w / 2;

      // Line 1: Big underline (centered)
      t4_drawCenteredLineInput(ctx, cx, 36, 380, line1, "", "", "bold 18px Inter", "18px Inter", true, true);

      // Line 2: mg PER mL (centered group)
      ctx.font = "18px Inter";
      const mgWidth = 75, mlWidth = 75;
      const mgPerTxt = "mg PER";
      const mlTxt = "mL";
      const mgPerWidth = ctx.measureText(mgPerTxt).width + 8;
      const mlTxtWidth = ctx.measureText(mlTxt).width + 8;
      const totalWidth2 = mgWidth + mgPerWidth + mlWidth + mlTxtWidth;
      let x2 = cx - totalWidth2 / 2;
      t4_drawCenteredLineInput(ctx, x2 + mgWidth/2, 68, mgWidth, mgVal, "", "", "16px Inter", "16px Inter", true, true);
      x2 += mgWidth;
      ctx.font = "18px Inter";
      ctx.fillStyle = "#222";
      ctx.textAlign = "left";
      ctx.fillText(mgPerTxt, x2, 66);
      x2 += mgPerWidth;
      t4_drawCenteredLineInput(ctx, x2 + mlWidth/2, 68, mlWidth, mlVal, "", "", "16px Inter", "16px Inter", true, true);
      x2 += mlWidth;
      ctx.font = "18px Inter";
      ctx.fillStyle = "#222";
      ctx.fillText(mlTxt, x2, 66);

      // Line 3: LOT#_________ MAN:_________ (centered group, dynamic width)
      ctx.font = "bold 16px Inter";
      const lotLabel = "LOT#";
      const manLabel = "MAN:";
      const lotLblWidth = ctx.measureText(lotLabel).width + 8;
      const manLblWidth = ctx.measureText(manLabel).width + 8;
      const spacing3 = 24;
      const totalWidth3 = lotLblWidth + lotWidth + spacing3 + manLblWidth + manWidth;
      let x3 = cx - totalWidth3 / 2;
      t4_drawCenteredLineInput(ctx, x3 + lotLblWidth + lotWidth/2, 102, lotWidth, lotVal, lotLabel, "", lotFont, "16px Inter", true, true);
      x3 += lotLblWidth + lotWidth + spacing3;
      t4_drawCenteredLineInput(ctx, x3 + manLblWidth + manWidth/2, 102, manWidth, manVal, manLabel, "", manFont, "16px Inter", true, true);

      // Line 4: EXP:__/__/____ (centered group)
      ctx.font = "16px Inter";
      const expLabel = "EXP:";
      const slash = "/";
      const expWidth = 35, dayWidth = 35, yearWidth = 55;
      const expLblWidth = ctx.measureText(expLabel).width + 6;
      const slashWidth = ctx.measureText(slash).width;
      const spacing4 = 4;
      const totalWidth4 = expLblWidth + expWidth + spacing4 + slashWidth + spacing4 + dayWidth + spacing4 + slashWidth + spacing4 + yearWidth;
      let x4 = cx - totalWidth4 / 2;
      ctx.font = "16px Inter";
      ctx.textAlign = "left";
      ctx.fillStyle = "#222";
      ctx.fillText(expLabel, x4, 135);
      x4 += expLblWidth;
      t4_drawCenteredLineInput(ctx, x4 + expWidth/2, 131, expWidth, expMonth, "", "", "bold 16px Inter", "16px Inter", true, true);
      x4 += expWidth + spacing4;
      ctx.font = "16px Inter";
      ctx.fillText(slash, x4, 135);
      x4 += slashWidth + spacing4;
      t4_drawCenteredLineInput(ctx, x4 + dayWidth/2, 131, dayWidth, expDay, "", "", "bold 16px Inter", "16px Inter", true, true);
      x4 += dayWidth + spacing4;
      ctx.font = "16px Inter";
      ctx.fillText(slash, x4, 135);
      x4 += slashWidth + spacing4;
      t4_drawCenteredLineInput(ctx, x4 + yearWidth/2, 131, yearWidth, expYear, "", "", "bold 16px Inter", "16px Inter", true, true);

      // Line 5: Barcode (centered, edge-to-edge)
      if(barcodeVal) {
        const tempBarCanvas = document.createElement('canvas');
        tempBarCanvas.width = 320;
        tempBarCanvas.height = 60;
        JsBarcode(tempBarCanvas, barcodeVal, {
          format: "CODE128",
          lineColor: "#222",
          width: 2,
          height: 50,
          margin: 0,
          displayValue: true,
          fontOptions: "bold",
          fontSize: 18,
          textMargin: 2,
        });
        ctx.drawImage(tempBarCanvas, (w-320)/2, 154, 320, 60);
      }

      canvas.toBlob(async (blob) => {
        try {
          await navigator.clipboard.write([new window.ClipboardItem({ [blob.type]: blob })]);
          document.getElementById("t4-copyBtn").textContent = "Copied!";
          setTimeout(()=>{document.getElementById("t4-copyBtn").textContent = "Copy Label as Image"}, 1300);
        } catch(e) {
          alert("Copy failed. Try right-clicking the image to copy.");
        }
      });
    };

    // On load, render barcode preview & update dynamic field widths
    t4_renderBarcodePreview();
    t4_updateFieldWidths();
  </script>
</body>
</html>
